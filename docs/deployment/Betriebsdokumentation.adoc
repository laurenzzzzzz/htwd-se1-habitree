= Betriebsdokumentation Habitree
:toc:
:toc-title: Inhaltsverzeichnis
:sectnums:

== Zielgruppe und Zweck

Diese Dokumentation richtet sich an technische Administratoren und ist Grundlage für die Inbetriebnahme, Konfiguration und Wartung der Habitree-Anwendung.

Sie ermöglicht:

* Deployment des Systems in Produktions- und Testumgebungen
* Konfiguration und Verwaltung der Systemkomponenten
* Fehlerdiagnose und Wartung
* Backup- und Restoreverfahren

*Zielgruppe:* Systemadministratoren mit Linux/Unix-Kenntnissen und Erfahrung in der Verwaltung von Docker-Containern und PostgreSQL-Datenbanken.

*Hinweis:* Diese Dokumentation konzentriert sich auf systemspezifische Besonderheiten von Habitree. Standarddokumentation für PostgreSQL, Docker, Node.js etc. wird verlinkt. Die produktive Hochschulinstanz läuft aktuell auf `iseproject01.informatik.htw-dresden.de:8000`; die folgenden Schritte beschreiben aber ausschließlich, wie Habitree auf einer eigenen Infrastruktur betrieben wird.

== Systemvoraussetzungen

=== Hardware

|===
|Komponente |Minimum |Empfohlen
|CPU |2 Kerne |4 Kerne (x86_64)
|RAM |4 GB |8 GB
|Festplatte |40 GB |50 GB (SSD)
|Netzwerk |1 Gbps |1 Gbps 
|===

=== Betriebssystem

* **Linux** (Ubuntu 20.04 LTS, Debian 11+, oder äquivalent)
* **macOS** 12+ (für lokale Entwicklung)
* Windows mit WSL2 (für lokale Entwicklung)

=== Software-Stack

|===
|Komponente |Version |Zweck
|Docker Engine |20.10+ |Container-Runtime
|Docker Compose |1.29+ |Container-Orchestrierung
|PostgreSQL |14+ |Datenbank (läuft in Container)
|Node.js |20 LTS |Laufzeitumgebung Backend
|Git |2.30+ |Versionskontrolle
|===

=== Netzwerk

* Internetzugriff für Package-Downloads und Updates
* Offene Ports:
  - **8000** (Backend API, intern oder extern je nach Konfiguration)
  - **5432** (PostgreSQL, nur intern in Docker-Netzwerk)
  - **3000** (Frontend Expo-Tunnel, optional)

== Systemarchitektur

Habitree besteht aus drei Komponenten:

[options="header"]
|===
|Komponente |Technologie |Beschreibung
|Frontend |React Native / Expo |Mobile App, React-basiert
|Backend |Node.js / Express |REST-API, läuft in Docker-Container
|Datenbank |PostgreSQL 14+ |Persistenter Datenspeicher, läuft in Docker-Container
|===

Das System wird über Docker Compose orchestriert. Die Komponenten kommunizieren über ein Docker-internes Netzwerk (`habitree-network`).

== Systemeinrichtung

=== Voraussetzungen

==== Docker installieren

Siehe offizielle Dokumentation: https://docs.docker.com/engine/install/

Überprüfung:
[source,shell]
----
docker --version
docker compose version
----

==== Git-Repository klonen

[source,shell]
----
git clone https://github.com/laurenzzzzzz/htwd-se1-habitree.git
----

=== Konfiguration

==== Umgebungsvariablen (.env-Datei)

Erstelle eine `.env`-Datei im Verzeichnis `src/backend/`:

[source,bash]
----
# Datenbank-Konfiguration
DB_USER=habitree_user
DB_PASSWORD=<secure-password-hier-setzen>
DB_NAME=habitree_db
DB_PORT=5432

# Backend-Server
PORT=8000
NODE_ENV=production
JWT_SECRET=<jwt-secret-hier-setzen>

# Externe API (optional)
DATABASE_URL=postgresql://${DB_USER}:${DB_PASSWORD}@db:5432/${DB_NAME}
----

*Sicherheitshinweise:*
- `DB_PASSWORD` und `JWT_SECRET` müssen komplexe, zufällige Strings sein (Mindestens 32 Zeichen, Mixed-Case, Zahlen, Sonderzeichen)
- Diese `.env`-Datei muss vor Git-Commits geschützt sein (.gitignore)
- Auf Produktionssystemen muss die Datei durch ein Secrets-Management-System ersetzt werden

==== PostgreSQL-Initialisierung

Die Datenbank wird automatisch beim ersten Start erstellt. Optional kann eine Seed-Datei vorab geladen werden:
//nochmal prüfen
[source,bash]
----
src/backend/prisma/init.sql
----

Diese wird automatisch beim Datenbankstart ausgeführt und kann Testdaten enthalten.

==== Datenbankverbindung (externe DB)

Falls eine externe PostgreSQL-Instanz verwendet wird (z.B. HTW-Server), setze in `.env`:

[source,bash]
----
DATABASE_URL=postgresql://user:password@external-host:5432/habitree_db
----

docker compose --profile local up -d backend
Dann starte nur das Backend ohne die lokale DB (Docker Compose Profile):

[source,shell]
----
docker compose up -d backend
----

=== Inbetriebnahme

==== Vollständiger Start (mit lokaler DB)

[source,shell]
----
cd src/backend
docker compose --profile local up -d
----
Hinweis: Das Profil "local" muss angegeben werden, damit auch der Datenbank-Service (db) mitgestartet wird.

Dies startet:
- PostgreSQL-Container (`habitree-db`)
- Express-Backend-Container (`habitree-backend`)

Hinweis zur automatischen Migration:

Wenn Sie den Stack mit `--profile local` starten, führt die aktuelle Backend-Image-Entrypoint-Skripte automatisch die ausstehenden Prisma-Migrationen gegen die lokale `db` aus, bevor der Node-Prozess gestartet wird. Dadurch ist in der Regel kein manueller Migrationsschritt mehr erforderlich.
Wenn Sie den Docker-Image- oder Entrypoint-Code geändert haben, bauen Sie das Backend-Image erneut mit `--build`, damit die Änderungen aktiv werden (siehe unten).

==== Datenbankmigration ausführen

Bei Start mit dem lokalen Compose-Profil (`--profile local`) werden ausstehende Prisma-Migrationen automatisch vom Backend-Entrypoint gegen die lokale `db` ausgeführt. Ein manueller Migrationsschritt ist in diesem Fall in der Regel nicht erforderlich.

Diese Sektion beschreibt ausschließlich, wie Migrationen gegen eine externe Datenbank (z. B. ein HTW-Server) manuell angewendet werden — nutzen Sie diese Schritte nur, wenn Sie nicht die lokale `db` verwenden.

1. Setzen Sie in `src/backend/.env` oder in Ihrer Umgebung die `DATABASE_URL` auf die externe Datenbank, z. B.:

[source,bash]
----
DATABASE_URL=postgresql://user:password@external-host:5432/habitree_db
----

2. Migrationen mit laufendem Backend-Container (Backend gegen externe DB starten und migrieren):

[source,shell]
----
cd src/backend
docker compose up -d backend
docker compose exec backend npx prisma migrate deploy
----

3. Alternativ: Migration einmalig in einem temporären Container (empfohlen für Wartungsaufgaben):

[source,shell]
----
cd src/backend
docker compose run --rm -e DATABASE_URL="postgresql://user:password@external-host:5432/habitree_db" backend npx prisma migrate deploy
----

Wichtige Hinweise:
- Erstellen Sie vor Migrationen stets ein Backup der Produktionsdatenbank.
- Verwenden Sie die `run --rm`-Variante, wenn Sie Migrationen unabhängig vom laufenden `backend`-Service anwenden möchten.
- Die automatische Entrypoint-Migration gilt nur für den lokalen Compose-Start mit `--profile local`.

==== Optionale Seed-Daten laden

[source,shell]
----
docker compose --profile local exec backend npx prisma db seed
----

Dies lädt Testdaten aus `prisma/seed.js`.

Falls der `backend`-Service nicht verfügbar ist, kann das Seeder-Skript in einem einmaligen Container ausgeführt werden:

[source,shell]
----
docker compose --profile local run --rm backend npx prisma db seed
----

==== Überprüfung des Systems

Health-Check des Backends:
[source,shell]
----
curl -s http://localhost:8000/health | jq .
----

Oder: Bei 200 OK ist der Service betriebsbereit.

=== Frontend (Expo)

Das Frontend wird separat deployed. Siehe link:../Anwenderdokumentation/Anwenderdokumentation.adoc[Anwenderdokumentation] für Benutzerbereitstellung.

== Systembetreuung

=== Laufende Überwachung

==== Container-Status überprüfen

[source,shell]
----
cd src/backend
docker compose ps
----

Erwartete Ausgabe:
- `habitree-backend`: Status `Up` mit Health `healthy`
- `habitree-db`: Status `Up` mit Health `healthy`

==== Logs anzeigen

Backend-Logs:
[source,shell]
----
docker compose logs -f backend
----

Datenbank-Logs:
[source,shell]
----
docker compose logs -f db
----

==== Automatische Restarts

Container sind mit `restart: unless-stopped` konfiguriert und starten automatisch nach System-Reboot.

=== Häufige Probleme und Lösungen

|===
|Problem |Ursache |Lösung
|Backend antwortet nicht (Timeout) |Port 8000 belegt oder Container abgestürzt |`docker compose restart backend` oder Portkonflikt prüfen
|Datenbank-Verbindungsfehler |DB nicht erreichbar oder `DATABASE_URL` falsch |`docker compose logs db` prüfen, `.env` überprüfen
|Migrationen schlagen fehl |Alter DB-Schema incompatibel mit neuem Code |`docker compose exec backend npx prisma migrate resolve --rolled-back <migration-name>`
|OOM-Fehler (Out of Memory) |Zu wenig RAM verfügbar |Siehe Systemvoraussetzungen, evtl. Docker-Memory-Limit erhöhen
|Frontend kann Backend nicht erreichen |DNS-Auflösung oder IP-Adresse falsch |Frontend-Konfiguration prüfen, `curl http://backend:8000/health` im Container testen
|===

=== Fehlerdiagnose

==== Backend-Logs analysieren

Typische Fehler:
- `ECONNREFUSED` → Datenbank nicht erreichbar
- `SequelizeConnectionError` → Datenbankverbindung fehlgeschlagen
- `INVALID_JWT` → `JWT_SECRET` falscher Wert

==== Datenbankzustand überprüfen

[source,shell]
----
docker compose exec db psql -U habitree_user -d habitree_db -c "SELECT * FROM \"user\";"
----

Oder via Prisma Studio:
[source,shell]
----
docker compose exec backend npx prisma studio
----

öffnet dann ein Web-Interface auf http://localhost:5555 (nur lokal erreichbar).

==== Container Debug-Modus

[source,shell]
----
docker compose exec backend sh
----

Dann innerhalb des Containers:
[source,shell]
----
node src/index.js  # Direkter Start mit Fehlerausgabe
npm run dev        # Mit Nodemon (automatischer Restart bei Änderungen)
----

=== Backup & Restore

==== Datenbank-Backup erstellen

[source,shell]
----
docker compose exec db pg_dump -U habitree_user habitree_db > backup_$(date +%Y%m%d_%H%M%S).sql
----

Dies erstellt eine SQL-Dump-Datei.

==== Backup in Docker-Volume sichern

Die Daten liegen im Docker-Volume `postgres_data`. Für regelmäßige Sicherungen:

[source,shell]
----
docker run --rm -v habitree-backend_postgres_data:/data -v $(pwd):/backup \
  alpine tar czf /backup/postgres_backup_$(date +%Y%m%d_%H%M%S).tar.gz /data
----

==== Restore aus Backup

Aus SQL-Dump:
[source,shell]
----
cat backup_20240115_120000.sql | docker compose exec -T db psql -U habitree_user habitree_db
----

Aus Volume-Backup: Container stoppen, Volume löschen, neu erstellen und Backup zurückschreiben (komplex - siehe https://docs.docker.com/storage/volumes/[Docker Volume Dokumentation]).

=== Datenbank-Schema-Änderungen

==== Neue Migration erstellen

Nach Änderung von `prisma/schema.prisma`:

[source,shell]
----
docker compose exec backend npx prisma migrate dev --name <description>
----

Dies erstellt eine neue Migration unter `prisma/migrations/`.

==== Migration auf Produktivserver durchführen

[source,shell]
----
docker compose exec backend npx prisma migrate deploy
----

Dies wendet alle ausstehenden Migrationen an. Die Datenbank wird während der Migration gesperrt.

*Hinweis:* Immer vor Migrationen auf Produktivservern ein Backup erstellen!

=== Datenbankadministration

==== Datenbank-Tabellen

Die Habitree-App nutzt folgende Tabellen (siehe `prisma/schema.prisma`):

|===
|Tabelle |Zweck
|`user` |Benutzer mit Authentifizierungsdaten
|`habit` |Habit-Vorlagen und Benutzer-Habits
|`predefined_habit` |Vordefinierte Habit-Templates
|`habitEntry` |Tägliche Habit-Einträge (Erfolgsprotokoll)
|`quote` |Motivations-Zitate
|===

==== Daten manuell hinzufügen/ändern

Via SQL (psql im Container):
[source,shell]
----
docker compose exec db psql -U habitree_user -d habitree_db
----

Beispiel: Benutzer löschen
[source,sql]
----
DELETE FROM "user" WHERE email = 'user@example.com';
----

*Warnung:* Manuelles Löschen kann CASCADE-Löschungen auslösen (Habits, Entries werden mitgelöscht).

Siehe https://www.postgresql.org/docs/[PostgreSQL Dokumentation] für erweiterte SQL-Operationen.

=== Performance-Tuning

|===
|Parameter |Empfohlener Wert |Grund
|DB Connection Pool |Default: 10 |Anzahl gleichzeitiger DB-Verbindungen
|Node.js Heap |--max-old-space-size=1024 |Wenn hohe Last > 1GB RAM nutzt
|PostgreSQL shared_buffers |25% RAM |Für größere Datenbanken
|===

Änderungen in `docker-compose.yml` oder `.env` durchführen und Container neu starten.

=== Sicherheits-Richtlinien

* **Datenbank-Passwort:** Komplexes Passwort verwenden (Mindestens 16 Zeichen)
* **JWT_SECRET:** Regelmäßig wechseln, starkes Secret verwenden
* **Firewall:** Port 8000 nur für vertraute Clients freigeben
* **Container-Updates:** Docker-Images regelmäßig aktualisieren (siehe https://docs.docker.com/engine/reference/commandline/pull/[Docker Pull])
* **Secrets-Management:** In Produktion externe Secrets-Systeme nutzen (z.B. HashiCorp Vault, AWS Secrets Manager)
* **Regelmäßige Backups:** Tägliche oder stündliche DB-Backups einrichten (Cron-Job empfohlen)

== Koexistenz mit HTW-Server

Die produktive Instanz der Hochschule erreicht man unter `iseproject01.informatik.htw-dresden.de:8000`. Diese Information dient lediglich zur Referenz, falls ein Abgleich oder ein Fallback auf das zentrale System nötig ist. Betrieb, Wartung und Deployments orientieren sich jedoch an einer selbst verwalteten Infrastruktur wie in den vorherigen Kapiteln beschrieben.

* **Eigene Umgebung:** Backend läuft auf `localhost:8000` bzw. dem jeweiligen Server-Host
* **HTW-Server:** Für Vergleichs- und Testzwecke
* **Frontend-Konfiguration:** Umgebungsvariable `BACKEND_URL` bestimmt, ob gegen das eigene System oder den Hochschulserver gearbeitet wird

== Dateistruktur (Referenz)

[options="header"]
|===
|Pfad |Inhalt |Zweck
|`src/backend/Dockerfile` |Multi-Stage Docker Build |Backend-Container erstellen
|`src/backend/docker-compose.yml` |Orchestrierung Backend + DB |Beide Services gemeinsam starten
|`src/backend/.env` |Umgebungsvariablen |Konfiguration (lokal/Produktion)
|`src/backend/prisma/schema.prisma` |Datenbankschema |Tabellen-Definitionen (ORM)
|`src/backend/prisma/migrations/` |Migrations-Scripts |Alle Schema-Änderungen dokumentiert
|`src/backend/src/index.js` |Express Server Entry-Point |API-Server Hauptdatei
|`src/backend/src/routes/` |API-Endpoints |Habits, User, Auth, Quotes
|===

== Anhang: Wichtige Docker Compose Befehle

|===
|Befehl |Beschreibung
|`docker compose up -d` |Start (Hintergrund)
|`docker compose down` |Stop und Cleanup
|`docker compose restart` |Neustart
|`docker compose logs -f` |Live-Logs anzeigen
|`docker compose ps` |Container-Status
|`docker compose exec <service> <cmd>` |Befehl im Container ausführen
|===

Siehe https://docs.docker.com/compose/reference/[Docker Compose CLI Reference].

== Support und Kontakt

Bei Problemen oder Fragen:

1. **Logs überprüfen:** `docker compose logs -f backend`
2. **Container-Status prüfen:** `docker compose ps`
3. **Disk-Space überprüfen:** `docker system df`
4. **Manuelle Tests:** SSH auf Host → `docker compose exec backend sh`

Siehe link:../architecture/architecture_notebook.adoc[Architektur-Dokumentation] für technische Details.
