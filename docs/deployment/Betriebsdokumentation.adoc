= Betriebsdokumentation Habitree
:toc:
:toc-title: Inhaltsverzeichnis
:sectnums:

== Zielgruppe und Zweck

Diese Dokumentation richtet sich an technische Administratoren und ist Grundlage für die Inbetriebnahme, Konfiguration und Wartung der Habitree-Anwendung.

Sie ermöglicht:

* Deployment des Systems in Produktions- und Testumgebungen
* Konfiguration und Verwaltung der Systemkomponenten
* Fehlerdiagnose und Wartung
* Backup- und Restoreverfahren

*Zielgruppe:* Systemadministratoren mit Linux/Unix-Kenntnissen und Erfahrung in der Verwaltung von Docker-Containern und PostgreSQL-Datenbanken.

*Hinweis:* Diese Dokumentation konzentriert sich auf systemspezifische Besonderheiten von Habitree. Standarddokumentation für PostgreSQL, Docker, Node.js etc. wird verlinkt. Die produktive Hochschulinstanz läuft aktuell auf `iseproject01.informatik.htw-dresden.de:8000`; die folgenden Schritte beschreiben aber ausschließlich, wie Habitree auf einer eigenen Infrastruktur betrieben wird.

== Systemvoraussetzungen

=== Hardware

|===
|Komponente |Minimum |Empfohlen
|CPU |2 Kerne |4 Kerne (x86_64)
|RAM |4 GB |8 GB
|Festplatte |40 GB |50 GB (SSD)
|Netzwerk |1 Gbps |1 Gbps 
|===

=== Betriebssystem

* **Linux** (Ubuntu 20.04 LTS, Debian 11+, oder äquivalent)
* **macOS** 12+ (für lokale Entwicklung)
* Windows mit WSL2 (für lokale Entwicklung)

=== Software-Stack

|===
|Komponente |Version |Zweck
|Docker Engine |20.10+ |Container-Runtime
|Docker Compose |1.29+ |Container-Orchestrierung
|PostgreSQL |14+ |Datenbank (läuft in Container)
|Node.js |20 LTS |Laufzeitumgebung Backend
|Git |2.30+ |Versionskontrolle
|===

=== Netzwerk

* Internetzugriff für Package-Downloads und Updates
* Offene Ports:
  - **8000** (Backend API, intern oder extern je nach Konfiguration)
  - **5432** (PostgreSQL, nur intern in Docker-Netzwerk)
  - **3000** (Frontend Expo-Tunnel, optional)

== Systemarchitektur

Habitree besteht aus drei Komponenten:

[options="header"]
|===
|Komponente |Technologie |Beschreibung
|Frontend |React Native / Expo |Mobile App, React-basiert
|Backend |Node.js / Express |REST-API, läuft in Docker-Container
|Datenbank |PostgreSQL 14+ |Persistenter Datenspeicher, läuft in Docker-Container
|===

Das System wird über Docker Compose orchestriert. Die Komponenten kommunizieren über ein Docker-internes Netzwerk (`habitree-network`).

== Systemeinrichtung

=== Voraussetzungen

==== Docker installieren

Siehe offizielle Dokumentation: https://docs.docker.com/engine/install/

Überprüfung:
[source,shell]
----
docker --version
docker compose version
----

==== Git-Repository klonen

[source,shell]
----
git clone https://github.com/laurenzzzzzz/htwd-se1-habitree.git
----

=== Konfiguration

==== Umgebungsvariablen (.env-Datei)

Erstelle eine `.env`-Datei im Verzeichnis `src/backend/`:

[source,bash]
----
# Datenbank-Konfiguration
DB_USER=habitree_user
DB_PASSWORD=<zufälliger_starker_string>
DB_NAME=habitree_db
DATABASE_PORT=5432

# Backend-Server
PORT=8000
NODE_ENV=production
JWT_SECRET=<zufälliger_starker_string>

# Optional: Externe Datenbank (falls nicht Docker-intern)
# DATABASE_URL=postgresql://${DB_USER}:${DB_PASSWORD}@external-host:5432/${DB_NAME}
----

*Sicherheitshinweise:*
- `DB_PASSWORD` und `JWT_SECRET` müssen komplexe, zufällige Strings sein (Mindestens 32 Zeichen, Mixed-Case, Zahlen, Sonderzeichen)
- Diese `.env`-Datei muss vor Git-Commits geschützt sein (.gitignore)
- Auf Produktionssystemen muss die Datei durch ein Secrets-Management-System ersetzt werden

==== PostgreSQL-Initialisierung

Die Datenbankstruktur wird primär über Prisma Migrations verwaltet (siehe unten).
Das Docker-Image ist so konfiguriert, dass Skripte im Ordner `src/backend/prisma/` (wie `init.sql`) beim allerersten Start der Datenbank (wenn das Volume noch leer ist) ausgeführt werden. Dies ist jedoch optional.

Die eigentliche Schema-Erstellung erfolgt durch den Backend-Start.

==== Datenbankverbindung (externe DB)

Falls eine externe PostgreSQL-Instanz verwendet wird, setze in `.env`:

[source,bash]
----
DATABASE_URL=postgresql://user:password@external-host:5432/habitree_db
----

Dann starte nur das Backend ohne die lokale DB:

[source,shell]
----
docker compose -f src/backend/docker-compose.yml up -d backend
----

=== Inbetriebnahme

==== Vollständiger Start (mit lokaler DB)

[source,shell]
----
docker compose -f src/backend/docker-compose.yml --profile local up -d
----
Hinweis: Das Profil "local" muss angegeben werden, damit auch der Datenbank-Service (db) mitgestartet wird, da er in `docker-compose.yml` als `profiles: ["local"]` definiert ist.

Dies startet:
- PostgreSQL-Container (`habitree-db`)
- Express-Backend-Container (`habitree-backend`)

Hinweis zur automatischen Migration:

Wenn Sie den Stack mit `--profile local` starten, führt das Entrypoint-Skript des Backend-Images automatisch die ausstehenden Prisma-Migrationen gegen die lokale `db` aus, bevor der Node-Prozess gestartet wird. Dadurch ist in der Regel kein manueller Migrationsschritt mehr erforderlich.
Wenn Sie den Docker-Image- oder Entrypoint-Code geändert haben, verwenden Sie zusätzlich `--build`:

[source,shell]
----
docker compose -f src/backend/docker-compose.yml --profile local up -d --build
----

==== Datenbankmigration ausführen

Bei Start mit dem lokalen Compose-Profil (`--profile local`) werden ausstehende Prisma-Migrationen automatisch vom Backend-Entrypoint gegen die lokale `db` ausgeführt. Ein manueller Migrationsschritt ist in diesem Fall in der Regel nicht erforderlich.

Diese Sektion beschreibt ausschließlich, wie Migrationen gegen eine externe Datenbank manuell angewendet werden — nutzen Sie diese Schritte nur, wenn Sie nicht die lokale `db` verwenden.

1. Setzen Sie in `src/backend/.env` oder in Ihrer Umgebung die `DATABASE_URL` auf die externe Datenbank, z. B.:

[source,bash]
----
DATABASE_URL=postgresql://user:password@external-host:5432/habitree_db
----

2. Migrationen mit laufendem Backend-Container (Backend gegen externe DB starten und migrieren):

[source,shell]
----
docker compose -f src/backend/docker-compose.yml up -d backend
docker compose -f src/backend/docker-compose.yml exec backend npx prisma migrate deploy
----

3. Alternativ: Migration einmalig in einem temporären Container (empfohlen für Wartungsaufgaben):

[source,shell]
----
docker compose -f src/backend/docker-compose.yml run --rm -e DATABASE_URL="postgresql://user:password@external-host:5432/habitree_db" backend npx prisma migrate deploy
----

Wichtige Hinweise:
- Erstellen Sie vor Migrationen stets ein Backup der Produktionsdatenbank.
- Verwenden Sie die `run --rm`-Variante, wenn Sie Migrationen unabhängig vom laufenden `backend`-Service anwenden möchten.

==== Optionale Seed-Daten laden

[source,shell]
docker compose -f src/backend/docker-compose.yml exec backend npx prisma db seed


Dies lädt Testdaten aus `prisma/seed.js`:

* **Vordefinierte Habits** (z.B. "Täglich Wasser trinken", "Morgendliches Stretching", "30 Minuten Lesen") werden als Templates in die Tabelle `predefinedHabit` eingefügt.
* **Test-User** mit der E-Mail `test@example.com` und Passwort `password123` wird angelegt (sofern nicht vorhanden).
* **Persönliche Habit-Instanzen** für den Test-User werden aus den Templates erstellt.
* **Tages-Einträge (habitEntry)** für den Test-User und die Habits werden für das aktuelle Datum angelegt.
* **Motivationssprüche (quotes)** werden eingefügt.

Die genauen Inhalte und Logik finden sich in `src/backend/prisma/seed.js`.

==== Überprüfung des Systems

Health-Check des Backends:
[source,shell]
----
curl -s http://localhost:8000/health
# Unter Windows PowerShell: curl.exe -s http://localhost:8000/health
----

Wenn die Antwort `{"status":"ok"}` (oder ähnlich) lautet, ist der Service betriebsbereit.


=== Frontend (Expo)

Das Frontend (mobile App) läuft lokal auf dem Smartphone (via Expo Go App) oder einem Emulator, **nicht** im Docker-Container. Der Docker-Container für das Frontend dient lediglich als "Packager" und Tunnel-Provider.

==== Netzwerkkonfiguration (WICHTIG)

Damit das Smartphone (im WLAN) mit dem Backend (auf dem PC im Docker-Netzwerk) kommunizieren kann, muss die **lokale IP-Adresse** des PCs konfiguriert werden. `localhost` funktioniert auf dem Handy nicht.

1. **Lokale IP ermitteln:**
   * Windows: `ipconfig` (IPv4-Adresse, z.B. 192.168.178.20)
   * Linux/Mac: `ifconfig` oder `ip addr`

2. **Konfiguration anpassen:**
   Öffnen Sie `src/habitree/constants/ApiConfig.ts` und tragen Sie die IP ein:

[source,typescript]
----
// src/habitree/constants/ApiConfig.ts
export const API_BASE_URL = 'http://192.168.x.x:8000'; 
----

3. **Voraussetzungen prüfen:**
   * **Netzwerk:** PC und Smartphone müssen im **selben WLAN** sein.
   * **Firewall:** Die Firewall des PCs muss eingehende Verbindungen auf Port 8000 zulassen.
   * **VPN:** VPN-Verbindungen (NordVPN, Tailscale, Uni-VPN) sollten deaktiviert werden, da sie oft das lokale Routing blockieren.

4. **Tunnel-Option (Alternative):**
   Falls eine direkte IP-Verbindung nicht möglich ist (z.B. Gast-WLAN), kann `ngrok` verwendet werden, um das Backend öffentlich verfügbar zu machen: `npx ngrok http 8000` -> URL in `ApiConfig.ts` eintragen.

[NOTE]
====
**Hinweis bei Verbindungsproblemen:**
Sollte die App trotz korrekter Netzwerkkonfiguration Verbindungsfehler anzeigen oder eine Anmeldung nicht möglich sein, versuchen Sie, sich in der App von Ihrem Habitree-Account abzumelden und anschließend erneut anzumelden. Dies kann insbesondere nach Änderungen an der Backend-URL oder nach Netzwerkwechseln helfen, Verbindungsprobleme zu beheben.
====

==== Start des Frontends

Die Entwicklungsumgebung ist als VS Code Dev Container konfiguriert. Dies stellt sicher, dass alle notwendigen Tools (Node.js, Expo CLI, ...) vorinstalliert sind.

1. **Projekt im Dev Container öffnen:**
   * Öffnen Sie den Projektordner in VS Code.
   * Klicken Sie auf das grüne Symbol unten links ("><") oder drücken Sie `F1`.
   * Wählen Sie **"Dev Containers: Reopen in Container"**.
   * VS Code startet neu und baut den Container (beim ersten Mal kann dies einige Minuten dauern).

2. **Verbindung herstellen:**
   * Scannen Sie den angezeigten QR-Code mit der **Expo Go** App (iOS/Android) auf Ihrem Smartphone.
   * Das Smartphone und der PC müssen Internetzugriff haben (durch die `--tunnel` Option ist kein gemeinsames WLAN zwingend erforderlich, aber empfohlen vorallem weil sich sonst die Verbindung zum Backend verkompliziert).




== Systembetreuung

=== Laufende Überwachung

==== Container-Status überprüfen

[source,shell]
----
docker compose -f src/backend/docker-compose.yml ps
----

Erwartete Ausgabe:
- `habitree-backend`: Status `Up` mit Health `healthy`
- `habitree-db`: Status `Up` mit Health `healthy` (nur mit Profil `local`)

==== Logs anzeigen

Backend-Logs:
[source,shell]
----
docker compose -f src/backend/docker-compose.yml logs -f backend
----

Datenbank-Logs:
[source,shell]
----
# Nur relevant bei lokaler Datenbank (Profil local)
docker compose -f src/backend/docker-compose.yml logs -f db
----

==== Automatische Restarts

Container sind mit `restart: unless-stopped` konfiguriert und starten automatisch nach System-Reboot.

=== Häufige Probleme und Lösungen

|===
|Problem |Ursache |Lösung
|Backend antwortet nicht (Timeout) |Port 8000 belegt oder Container abgestürzt |`docker compose -f src/backend/docker-compose.yml restart backend` oder Portkonflikt prüfen
|Datenbank-Verbindungsfehler |DB nicht erreichbar oder `DATABASE_URL` falsch |`docker compose -f src/backend/docker-compose.yml [--profile local] logs db` prüfen, `.env` überprüfen
|Migrationen schlagen fehl |Alter DB-Schema incompatibel mit neuem Code |`docker compose -f src/backend/docker-compose.yml exec backend npx prisma migrate resolve --rolled-back <migration-name>`
|OOM-Fehler (Out of Memory) |Zu wenig RAM verfügbar |Siehe Systemvoraussetzungen, evtl. Docker-Memory-Limit erhöhen
|Frontend kann Backend nicht erreichen |DNS-Auflösung oder IP-Adresse falsch bzw. Session-Problem |Frontend-Konfiguration prüfen, `curl http://backend:8000/health` im Container testen. Zusätzlich: Bei Verbindungsproblemen in der App ab- und wieder anmelden, um mögliche Session-Probleme zu beheben.
|===

=== Fehlerdiagnose

==== Backend-Logs analysieren

Typische Fehler:
- `ECONNREFUSED` → Datenbank nicht erreichbar
- `SequelizeConnectionError` → Datenbankverbindung fehlgeschlagen
- `INVALID_JWT` → `JWT_SECRET` falscher Wert

==== Datenbankzustand überprüfen

[source,shell]
----
# Funktioniert nur bei lokaler Datenbank
docker compose -f src/backend/docker-compose.yml exec db psql -U habitree_user -d habitree_db -c 'SELECT * FROM "user";'
----

Oder via Prisma Studio:
[source,shell]
----
docker compose -f src/backend/docker-compose.yml exec backend npx prisma studio
----

öffnet dann ein Web-Interface auf http://localhost:5555 (nur lokal erreichbar).

==== Container Debug-Modus

[source,shell]
----
docker compose -f src/backend/docker-compose.yml exec backend sh
----

Dann innerhalb des Containers:
[source,shell]
----
node src/index.js  # Direkter Start mit Fehlerausgabe
npm run dev        # Mit Nodemon (automatischer Restart bei Änderungen)
----

=== Backup & Restore

==== Datenbank-Backup erstellen

[source,shell]
----
# Linux / Mac
docker compose -f src/backend/docker-compose.yml [--profile local] exec db pg_dump -U habitree_user habitree_db > backup_$(date +%Y%m%d_%H%M%S).sql

# Windows PowerShell
docker compose -f src/backend/docker-compose.yml [--profile local] exec db pg_dump -U habitree_user habitree_db > ("backup_" + (Get-Date -Format "yyyyMMdd_HHmmss") + ".sql")
----

Dies erstellt eine SQL-Dump-Datei. (Funktioniert nur mit lokaler DB).


==== Restore aus Backup

Aus SQL-Dump:
[source,shell]
----
# Funktioniert nur bei lokaler Datenbank
cat backup_20240115_120000.sql | docker compose -f src/backend/docker-compose.yml [--profile local] exec -T db psql -U habitree_user habitree_db
----

(Funktioniert nur mit lokaler DB).


=== Datenbank-Schema-Änderungen

==== Neue Migration erstellen

Nach Änderung von `prisma/schema.prisma`:

[source,shell]
----
docker compose -f src/backend/docker-compose.yml exec backend npx prisma migrate dev --name <description>
----

Dies erstellt eine neue Migration unter `prisma/migrations/`.

==== Migration auf Produktivserver durchführen

[source,shell]
----
docker compose -f src/backend/docker-compose.yml exec backend npx prisma migrate deploy
----

Dies wendet alle ausstehenden Migrationen an. Die Datenbank wird während der Migration gesperrt.

*Hinweis:* Immer vor Migrationen auf Produktivservern ein Backup erstellen!

=== Datenbankadministration

==== Datenbank-Tabellen

Die Habitree-App nutzt folgende Tabellen (siehe `prisma/schema.prisma`):

[plantuml]
....
include::../development/plantuml/datenbank-beziehungen.plantuml[]
....

==== Daten manuell hinzufügen/ändern

Via SQL (psql im Container):
[source,shell]
----
# Funktioniert nur bei lokaler Datenbank
docker compose -f src/backend/docker-compose.yml [--profile local] exec db psql -U habitree_user -d habitree_db
----

(Funktioniert nur mit lokaler DB).

Beispiel: Benutzer löschen
[source,sql]
----
DELETE FROM "user" WHERE email = 'user@example.com';
----

*Warnung:* Manuelles Löschen kann CASCADE-Löschungen auslösen (Habits, Entries werden mitgelöscht).

Siehe https://www.postgresql.org/docs/[PostgreSQL Dokumentation] für erweiterte SQL-Operationen.

=== Performance-Tuning

|===
|Parameter |Empfohlener Wert |Grund
|DB Connection Pool |Default: 10 |Anzahl gleichzeitiger DB-Verbindungen
|Node.js Heap |--max-old-space-size=1024 |Wenn hohe Last > 1GB RAM nutzt
|PostgreSQL shared_buffers |25% RAM |Für größere Datenbanken
|===

Änderungen in `docker-compose.yml` oder `.env` durchführen und Container neu starten.

=== Sicherheits-Richtlinien

* **Datenbank-Passwort:** Komplexes Passwort verwenden (Mindestens 16 Zeichen)
* **JWT_SECRET:** Regelmäßig wechseln, starkes Secret verwenden
* **Firewall:** Port 8000 nur für vertraute Clients freigeben
* **Container-Updates:** Docker-Images regelmäßig aktualisieren (siehe https://docs.docker.com/engine/reference/commandline/pull/[Docker Pull])
* **Secrets-Management:** In Produktion externe Secrets-Systeme nutzen (z.B. HashiCorp Vault, AWS Secrets Manager)
* **Regelmäßige Backups:** Tägliche oder stündliche DB-Backups einrichten (Cron-Job empfohlen)

== Dateistruktur (Referenz)

[options="header"]
|===
|Pfad |Inhalt |Zweck
|`src/backend/Dockerfile` |Multi-Stage Docker Build |Backend-Container erstellen
|`src/backend/docker-compose.yml` |Orchestrierung Backend + DB |Beide Services gemeinsam starten
|`src/backend/.env` |Umgebungsvariablen |Konfiguration (lokal/Produktion)
|`src/backend/prisma/schema.prisma` |Datenbankschema |Tabellen-Definitionen (ORM)
|`src/backend/prisma/migrations/` |Migrations-Scripts |Alle Schema-Änderungen dokumentiert
|`src/backend/src/index.js` |Express Server Entry-Point |API-Server Hauptdatei
|`src/backend/src/routes/` |API-Endpoints |Habits, User, Auth, Quotes
|===

== Anhang: Wichtige Docker Compose Befehle

|===
|Befehl |Beschreibung
|`docker compose up -d` |Start (Hintergrund)
|`docker compose down` |Stop und Cleanup
|`docker compose restart` |Neustart
|`docker compose logs -f` |Live-Logs anzeigen
|`docker compose ps` |Container-Status
|`docker compose exec <service> <cmd>` |Befehl im Container ausführen
|===

Siehe https://docs.docker.com/compose/reference/[Docker Compose CLI Reference].

== Support und Kontakt

Bei Problemen oder Fragen:

1. **Logs überprüfen:** `docker compose -f src/backend/docker-compose.yml logs -f backend`
2. **Container-Status prüfen:** `docker compose -f src/backend/docker-compose.yml [--profile local] ps`
3. **Disk-Space überprüfen:** `docker system df`
4. **Manuelle Tests:** SSH auf Host → `docker compose -f src/backend/docker-compose.yml exec backend sh`

Siehe link:../architecture/architecture_notebook.adoc[Architektur-Dokumentation] für technische Details.
